backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â”œâ”€â”€ person/
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ use-cases/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ validators/
â”‚   â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ middlewares/
â”‚   â”‚   â”‚   â””â”€â”€ interface/
â”‚   â”‚   â”‚       â”œâ”€â”€ routes/
â”‚   â”‚   â”‚       â””â”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ role/
â”‚   â”‚   â”œâ”€â”€ permission/
â”‚   â”‚   â””â”€â”€ auth/
â”‚   â”œâ”€â”€ shared/
â”‚   â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ constants/
â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ errors/
â”‚   â”œâ”€â”€ config/
â”‚   â””â”€â”€ app.ts

2. ðŸ“Š MEJORAS EN EL MODELO DE DATOS
Agregar Campos Esenciales

model person {
  // ... campos existentes ...
  
  // Campos para autenticaciÃ³n
  username        String?         @unique
  password_hash   String?
  last_login      DateTime?
  login_attempts  Int             @default(0)
  locked_until    DateTime?
  
  // Campos para UX
  status          PersonStatus    @default(ACTIVE)
  priority        Int             @default(0)
  tags            String[]        // Para categorizaciÃ³n
  
  // Campos para internacionalizaciÃ³n
  language        String          @default("es")
  timezone        String          @default("America/Bogota")
  
  // Campos para notificaciones
  notification_preferences Json?  // Preferencias de notificaciÃ³n
  
  // Campos para validaciÃ³n
  email_verified  Boolean         @default(false)
  phone_verified  Boolean         @default(false)
  document_verified Boolean       @default(false)
  
  // Campos para auditorÃ­a mejorada
  verified_by     Int?
  verified_at     DateTime?
  
  @@index([status])
  @@index([priority])
  @@index([created_at])
}

enum PersonStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
  BLOCKED
}


3. ðŸ” SISTEMA DE AUTENTICACIÃ“N ROBUSTO
Modelo de Sesiones

model user_session {
  id              String          @id @default(cuid())
  person_id       Int
  token           String          @unique
  refresh_token   String          @unique
  device_info     Json?
  ip_address      String?
  user_agent      String?
  expires_at      DateTime
  created_at      DateTime        @default(now())
  last_activity   DateTime        @default(now())
  is_active       Boolean         @default(true)
  
  person          person          @relation(fields: [person_id], references: [id])
  
  @@index([person_id])
  @@index([expires_at])
}

4. ðŸ“ SISTEMA DE VALIDACIÃ“N MEJORADO
DTOs y Validaciones


// DTOs para diferentes operaciones
export class CreatePersonDto {
  @IsString()
  @IsNotEmpty()
  @Length(2, 100)
  full_name: string;

  @IsString()
  @IsNotEmpty()
  @Matches(/^(CC|CE|TI|PP|NIT)$/)
  document_type: string;

  @IsString()
  @IsNotEmpty()
  @Length(5, 20)
  document_number: string;

  @IsEmail()
  @IsOptional()
  email?: string;

  @IsPhoneNumber()
  @IsOptional()
  phone?: string;

  @IsDateString()
  @IsOptional()
  birth_date?: string;

  @IsEnum(['M', 'F', 'O'])
  @IsOptional()
  gender?: string;
}

export class UpdatePersonDto extends PartialType(CreatePersonDto) {
  @IsOptional()
  @IsBoolean()
  is_active?: boolean;
}

export class BulkCreatePersonDto {
  @IsArray()
  @ValidateNested({ each: true })
  @Type(() => CreatePersonDto)
  persons: CreatePersonDto[];

  @IsOptional()
  @IsBoolean()
  skip_duplicates?: boolean;

  @IsOptional()
  @IsBoolean()
  validate_only?: boolean;
}

5. ðŸŽ¯ RESPUESTAS ESTANDARIZADAS
Interfaces de Respuesta

// Respuesta estÃ¡ndar para Ã©xito
export interface ApiResponse<T = any> {
  success: boolean;
  message: string;
  data?: T;
  meta?: {
    timestamp: string;
    operation: string;
    version: string;
    requestId: string;
  };
  errors?: ValidationError[];
}

// Respuesta para listas paginadas
export interface PaginatedResponse<T> {
  success: boolean;
  message: string;
  data: {
    items: T[];
    pagination: {
      page: number;
      limit: number;
      total: number;
      pages: number;
      hasNext: boolean;
      hasPrev: boolean;
    };
    filters?: Record<string, any>;
    sorting?: {
      field: string;
      direction: 'asc' | 'desc';
    };
  };
  meta: {
    timestamp: string;
    operation: string;
    version: string;
    requestId: string;
  };
}

// Respuesta para operaciones masivas
export interface BulkOperationResponse {
  success: boolean;
  message: string;
  data: {
    total: number;
    successful: number;
    failed: number;
    results: {
      successful: Array<{ id: number; data: any }>;
      failed: Array<{ data: any; errors: string[] }>;
    };
  };
  meta: {
    timestamp: string;
    operation: string;
    version: string;
    requestId: string;
  };
}

6. ðŸ” SISTEMA DE BÃšSQUEDA AVANZADO
Filtros y BÃºsqueda
export class PersonFiltersDto {
  @IsOptional()
  @IsString()
  search?: string; // BÃºsqueda en nombre, documento, email

  @IsOptional()
  @IsArray()
  @IsEnum(PersonStatus, { each: true })
  status?: PersonStatus[];

  @IsOptional()
  @IsArray()
  @IsNumber({}, { each: true })
  roles?: number[];

  @IsOptional()
  @IsArray()
  @IsNumber({}, { each: true })
  residential_units?: number[];

  @IsOptional()
  @IsDateString()
  created_after?: string;

  @IsOptional()
  @IsDateString()
  created_before?: string;

  @IsOptional()
  @IsBoolean()
  has_vehicles?: boolean;

  @IsOptional()
  @IsBoolean()
  has_roles?: boolean;

  @IsOptional()
  @IsArray()
  @IsString({ each: true })
  tags?: string[];
}

export class PersonSortDto {
  @IsOptional()
  @IsEnum(['full_name', 'created_at', 'updated_at', 'document_number'])
  field?: string;

  @IsOptional()
  @IsEnum(['asc', 'desc'])
  direction?: 'asc' | 'desc';
}

7. ï¿½ï¿½ SISTEMA DE AUDITORÃA MEJORADO
Modelo de AuditorÃ­a
model audit_log {
  id              Int             @id @default(autoincrement())
  table_name      String
  record_id       Int
  operation       String          // CREATE, UPDATE, DELETE, RESTORE
  old_values      Json?
  new_values      Json?
  changed_fields  String[]
  user_id         Int?
  ip_address      String?
  user_agent      String?
  created_at      DateTime        @default(now())
  
  user            person?         @relation(fields: [user_id], references: [id])
  
  @@index([table_name, record_id])
  @@index([operation])
  @@index([created_at])
  @@index([user_id])
}

8. ðŸš€ ENDPOINTS MEJORADOS
API Completa y Robusta

// GestiÃ³n de Personas
GET    /api/v1/persons                    // Listar con filtros avanzados
GET    /api/v1/persons/:id                // Obtener con relaciones
POST   /api/v1/persons                    // Crear con validaciÃ³n
PUT    /api/v1/persons/:id                // Actualizar completo
PATCH  /api/v1/persons/:id                // Actualizar parcial
DELETE /api/v1/persons/:id                // Soft delete
POST   /api/v1/persons/:id/restore        // Restaurar

// Operaciones Masivas
POST   /api/v1/persons/bulk               // Crear mÃºltiples
PUT    /api/v1/persons/bulk               // Actualizar mÃºltiples
DELETE /api/v1/persons/bulk               // Eliminar mÃºltiples
POST   /api/v1/persons/import             // Importar CSV/Excel
GET    /api/v1/persons/export             // Exportar CSV/Excel

// ValidaciÃ³n y VerificaciÃ³n
POST   /api/v1/persons/validate           // Validar datos
GET    /api/v1/persons/duplicates         // Detectar duplicados
POST   /api/v1/persons/:id/verify         // Verificar usuario
POST   /api/v1/persons/:id/verify-email   // Verificar email
POST   /api/v1/persons/:id/verify-phone   // Verificar telÃ©fono

// GestiÃ³n de Roles
GET    /api/v1/persons/:id/roles          // Roles del usuario
POST   /api/v1/persons/:id/roles          // Asignar rol
PUT    /api/v1/persons/:id/roles/:roleId  // Actualizar rol
DELETE /api/v1/persons/:id/roles/:roleId  // Remover rol
POST   /api/v1/persons/bulk-roles         // Asignar roles masivamente

// BÃºsqueda y Filtros
GET    /api/v1/persons/search             // BÃºsqueda avanzada
GET    /api/v1/persons/autocomplete       // Autocompletado
GET    /api/v1/persons/filters            // Obtener filtros disponibles

// Reportes y EstadÃ­sticas
GET    /api/v1/persons/stats              // EstadÃ­sticas generales
GET    /api/v1/persons/stats/by-role      // Por rol
GET    /api/v1/persons/stats/by-status    // Por estado
GET    /api/v1/persons/reports            // Reportes

// AuditorÃ­a
GET    /api/v1/persons/:id/audit          // Historial de cambios
GET    /api/v1/audit/persons              // AuditorÃ­a general
GET    /api/v1/audit/export               // Exportar auditorÃ­a

// GestiÃ³n de Archivos
POST   /api/v1/persons/:id/photo          // Subir foto
DELETE /api/v1/persons/:id/photo          // Eliminar foto
POST   /api/v1/persons/:id/documents      // Subir documentos
GET    /api/v1/persons/:id/documents      // Listar documentos
DELETE /api/v1/persons/:id/documents/:id  // Eliminar documento


9. ðŸ”§ MIDDLEWARE Y UTILIDADES
Middleware Esenciales
// Middleware de autenticaciÃ³n
export const authMiddleware = async (req, res, next) => {
  // Validar JWT token
  // Verificar permisos
  // Agregar usuario al request
};

// Middleware de validaciÃ³n
export const validationMiddleware = (schema: any) => {
  return async (req, res, next) => {
    // Validar request body
    // Sanitizar datos
    // Manejar errores de validaciÃ³n
  };
};

// Middleware de auditorÃ­a
export const auditMiddleware = (operation: string) => {
  return async (req, res, next) => {
    // Registrar operaciÃ³n
    // Guardar cambios
    // Agregar metadata
  };
};

// Middleware de rate limiting
export const rateLimitMiddleware = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutos
  max: 100, // mÃ¡ximo 100 requests por ventana
  message: 'Demasiadas requests desde esta IP'
});

// Middleware de manejo de errores
export const errorHandler = (err, req, res, next) => {
  // Log del error
  // Respuesta estandarizada
  // NotificaciÃ³n si es crÃ­tico
};

10. ðŸ“± PREPARACIÃ“N PARA FRONTEND
ConfiguraciÃ³n CORS

// ConfiguraciÃ³n CORS para frontend
app.use(cors({
  origin: process.env.FRONTEND_URL || 'http://localhost:4200',
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With']
}));

Headers para Frontend

// Headers de seguridad
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"],
    },
  },
}));

ðŸŽ¯ PLAN DE IMPLEMENTACIÃ“N MEJORADO
Fase 1: Base Robusta (Semana 1)
âœ… Estructura de carpetas Clean Architecture
âœ… Modelos mejorados con campos adicionales
âœ… Sistema de validaciÃ³n robusto
âœ… Middleware esenciales
âœ… Respuestas estandarizadas
Fase 2: CRUD Completo (Semana 2)
âœ… CRUD individual con validaciones
âœ… Operaciones masivas
âœ… ImportaciÃ³n/ExportaciÃ³n CSV
âœ… Sistema de auditorÃ­a
âœ… Manejo de errores
Fase 3: Funcionalidades Avanzadas (Semana 3)
âœ… BÃºsqueda y filtros avanzados
âœ… Sistema de roles y permisos
âœ… Reportes y estadÃ­sticas
âœ… GestiÃ³n de archivos
âœ… Notificaciones
Fase 4: OptimizaciÃ³n y Testing (Semana 4)
âœ… Tests unitarios y de integraciÃ³n
âœ… OptimizaciÃ³n de performance
âœ… DocumentaciÃ³n de API
âœ… ConfiguraciÃ³n para producciÃ³n
âœ… PreparaciÃ³n para frontend
